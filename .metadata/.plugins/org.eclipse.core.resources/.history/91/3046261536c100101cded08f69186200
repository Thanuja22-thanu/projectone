package com.flightbooking.service;

import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.flightbooking.dao.BookingDao;
import com.flightbooking.dto.ResponseStructure;
import com.flightbooking.entity.Booking;
import com.flightbooking.entity.Flight;
import com.flightbooking.entity.Passenger;
import com.flightbooking.entity.Payment;
import com.flightbooking.exception.Bookingnotfoundexception;
import com.flightbooking.exception.Idnotfoundexception;
import com.flightbooking.exception.Norecordavailableexception;
import com.flightbooking.exception.Paymentnotfoundexception;

import jakarta.transaction.Transactional;
@Service
@Transactional
public class BookingService {

    @Autowired
    private BookingDao bookingDao;

    public ResponseEntity<ResponseStructure<Booking>> createbooking(Booking booking) {

        Integer flightId = booking.getFlight().getId();
        Optional<Flight> optionalFlight = bookingDao.getFlightById(flightId);

        Flight existingFlight = null;
        if (optionalFlight.isPresent()) {
            existingFlight = optionalFlight.get();
        } else {
            throw new Idnotfoundexception("Flight not found with ID: " + flightId);
        }

        booking.setFlight(existingFlight);
          int passengerCount=0;
        if (booking.getPassengers() != null && !booking.getPassengers().isEmpty()) {
            for (Passenger p : booking.getPassengers()) {
                p.setBooking(booking);
            }
            passengerCount = booking.getPassengers().size();
            
        }

        double ticketprice =  existingFlight.getPrice(); 
        
        double totalAmount = ticketprice * passengerCount;

        
        if (booking.getPayment() != null) {
            booking.getPayment().setAmount(totalAmount);
            booking.getPayment().setPaymentdate(LocalDate.now());
            booking.getPayment().setBooking(booking);
        }


        ResponseStructure<Booking> response = new ResponseStructure<>();
        response.setStatusCode(HttpStatus.CREATED.value());
        response.setMessage("Booking saved successfully");
        response.setData(bookingDao.createbooking(booking));

        return new ResponseEntity<>(response, HttpStatus.CREATED);
    }

   

	public ResponseEntity<ResponseStructure<List<Booking>>> getallbooking() {
		ResponseStructure<List<Booking>> response = new ResponseStructure<List<Booking>>();
		if (!bookingDao.getallbooking().isEmpty()) {
			response.setStatusCode(HttpStatus.OK.value());
			response.setMessage(" all booking records retrieved");
			response.setData(bookingDao.getallbooking());

			return new ResponseEntity<ResponseStructure<List<Booking>>>(response, HttpStatus.OK);
		} else {
			throw new Norecordavailableexception("no booking records are available");
		}
	}



	public ResponseEntity<ResponseStructure<Booking>> getbookingbyid( Integer id) {
		 ResponseStructure<Booking> response = new ResponseStructure<>();
		Optional<Booking> opt=bookingDao.getbookingbyid(id);
				if(opt.isPresent()) {
					response.setStatusCode(HttpStatus.OK.value());
					response.setMessage("booking record  with "+id+" retrieved");
					response.setData(opt.get());

					return new ResponseEntity<ResponseStructure<Booking>>(response, HttpStatus.OK);
				} else {
					throw new Norecordavailableexception("record with "+id+" is not available");
				}
			}



	public ResponseEntity<ResponseStructure<List<Booking>>> getbookingbydate(LocalDate bookingdate) {
		ResponseStructure<List<Booking>> response = new ResponseStructure<List<Booking>>();
		if (!bookingDao.getbookingbydate(bookingdate).isEmpty()) {
			response.setStatusCode(HttpStatus.OK.value());
			response.setMessage(" record with bookingdate" +bookingdate+" is retrieved");
			response.setData(bookingDao.getbookingbydate(bookingdate));

			return new ResponseEntity<ResponseStructure<List<Booking>>>(response, HttpStatus.OK);
		} else {
			throw new Norecordavailableexception("record with booking "+bookingdate+"is not available");
		}
		
	
	}

		 public ResponseEntity<ResponseStructure<List<Booking>>> getBookingsByFlightId(Integer flightId) {
		        List<Booking> bookings = bookingDao.getBookingsByFlightId(flightId);

		        ResponseStructure<List<Booking>> response = new ResponseStructure<>();
		        if (!(bookings.isEmpty())) {
		        	response.setMessage("Bookings with flightid"+flightId+"has been retrieved");
		            response.setStatusCode(HttpStatus.OK.value());
		            response.setData(bookings);
		            return new ResponseEntity<>(response, HttpStatus.OK);
		            
		        } else { 
		        	throw new Norecordavailableexception("no bookings are available with the filghtid"+flightId+"");
		        	
		            
		        }
	}



		 public ResponseEntity<ResponseStructure<List<Booking>>> getbookingbystatus(String bookingstatus) {
			 ResponseStructure<List<Booking>> response = new ResponseStructure<List<Booking>>();
				if (!bookingDao.getbookingbystatus(bookingstatus).isEmpty()) {
					response.setStatusCode(HttpStatus.OK.value());
					response.setMessage(" record with bookingstatus" +bookingstatus+" is retrieved");
					response.setData(bookingDao.getbookingbystatus(bookingstatus));

					return new ResponseEntity<ResponseStructure<List<Booking>>>(response, HttpStatus.OK);
				} else {
					throw new Norecordavailableexception("record with booking "+bookingstatus+"is not available");
				}
			
		 }



		 
			 public ResponseEntity<ResponseStructure<Booking>> updatebooking(Booking booking) {

					ResponseStructure<Booking> response = new ResponseStructure<Booking>();
					if (booking.getId()==null) {
						throw new Idnotfoundexception("id must be passed to a update record");
					}
					Optional <Booking> opt=bookingDao.getbookingbyid(booking.getId());
					if(opt.isPresent()) {
						response.setStatusCode(HttpStatus.OK.value());
						response.setMessage("flight record updated");
						response.setData(bookingDao.createbooking(booking));

						return new ResponseEntity<ResponseStructure<Booking>>(response, HttpStatus.OK);
					} 
				     else {
						throw new Idnotfoundexception("no flight records are available");
					}
				}
			 public ResponseEntity<ResponseStructure<List<Passenger>>> getAllPassengersInBooking(Integer bookingId) {

				    Optional<Booking> optionalBooking = bookingDao.getbookingbyid(bookingId);

				    if (optionalBooking.isEmpty()) {
				        throw new Bookingnotfoundexception("Booking not found with id " + bookingId);
				    }

				    Booking booking = optionalBooking.get();
				    List<Passenger> passengers = booking.getPassengers();

				    ResponseStructure<List<Passenger>> structure = new ResponseStructure <List<Passenger>>();
				    structure.setMessage("Passengers fetched successfully");
				    structure.setData(passengers);
				    structure.setStatusCode(HttpStatus.OK.value());

				    return new ResponseEntity<ResponseStructure<List<Passenger>>>(structure, HttpStatus.OK);
				}

			
		 
public ResponseEntity<ResponseStructure<Payment>> getPaymentOfBooking(Integer id) {

    Optional<Booking> optional = bookingDao.getbookingbyid(id);

    if (optional.isEmpty()) {
        throw new Bookingnotfoundexception("Booking id " + id + " not found");
    }

    Booking booking = optional.get();

    Payment payment = booking.getPayment();  // ‚≠ê important line

    if (payment == null) {
        throw new Paymentnotfoundexception("No payment found for booking id " + id);
    }

    ResponseStructure<Payment> structure = new ResponseStructure<Payment>();
    structure.setMessage("Payment details fetched successfully");
    structure.setStatusCode(HttpStatus.OK.value());
    structure.setData(payment);

    return new ResponseEntit<ResponseStructure<Payment>>(structure, HttpStatus.OK);
}
}





		
	
		
	

	


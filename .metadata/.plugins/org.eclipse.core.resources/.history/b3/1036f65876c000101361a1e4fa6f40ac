package com.flightbooking.service;

import java.time.LocalDate;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.flightbooking.dao.BookingDao;
import com.flightbooking.dto.ResponseStructure;
import com.flightbooking.entity.Booking;
import com.flightbooking.entity.Flight;
import com.flightbooking.entity.Passenger;

import jakarta.transaction.Transactional;
@Service
@Transactional
public class BookingService {

    @Autowired
    private BookingDao bookingDao;

    public ResponseEntity<ResponseStructure<Booking>> createbooking(Booking booking) {

        Integer flightId = booking.getFlight().getId();
        Optional<Flight> optionalFlight = bookingDao.getFlightById(flightId);

        Flight existingFlight = null;
        if (optionalFlight.isPresent()) {
            existingFlight = optionalFlight.get();
        } else {
            throw new RuntimeException("Flight not found with ID: " + flightId);
        }

        booking.setFlight(existingFlight);
          int passengerCount=0;
        if (booking.getPassengers() != null && !booking.getPassengers().isEmpty()) {
            for (Passenger p : booking.getPassengers()) {
                p.setBooking(booking);
            }
            passengerCount = booking.getPassengers().size();
            
        }

        double baseFare =  existingFlight.getPrice(); 
        
        double totalAmount = baseFare * passengerCount;

        
        if (booking.getPayment() != null) {
            booking.getPayment().setAmount(totalAmount);
            booking.getPayment().setPaymentdate(LocalDate.now());
            booking.getPayment().setBooking(booking);
        }


        ResponseStructure<Booking> response = new ResponseStructure<>();
        response.setStatusCode(HttpStatus.CREATED.value());
        response.setMessage("Booking saved successfully");
        response.setData(bookingDao.createbooking(booking));

        return new ResponseEntity<>(response, HttpStatus.CREATED);
    }
}

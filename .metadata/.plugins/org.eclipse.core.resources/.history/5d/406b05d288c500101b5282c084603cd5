package com.flightbooking.service;

import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.flightbooking.dao.BookingDao;
import com.flightbooking.dao.PaymentDao;
import com.flightbooking.dto.ResponseStructure;
import com.flightbooking.entity.Booking;
import com.flightbooking.entity.Passenger;
import com.flightbooking.entity.Payment;
import com.flightbooking.entity.Paymentmode;
import com.flightbooking.entity.Paymentstatus;
import com.flightbooking.exception.Bookingnotfoundexception;
import com.flightbooking.exception.Idnotfoundexception;
import com.flightbooking.exception.Paymentnotfoundexception;

@Service
	public class PaymentService {

	    @Autowired
	    private PaymentDao paymentdao;
	    @Autowired
	    private BookingDao bookingDao;
	    
	    public ResponseEntity<ResponseStructure<Payment>> savePayment(Payment payment) {

	        // --- 1️⃣ Validate booking ---
	        if (payment.getBooking() == null || payment.getBooking().getId() == null) {
	            throw new Idnotfoundexception("Booking ID must be provided");
	        }

	        Integer bookingId = payment.getBooking().getId();

	        // Fetch existing booking
	        Optional<Booking> optBooking = bookingDao.getbookingbyid (bookingId);
	        if (optBooking.isEmpty()) {
	            throw new Bookingnotfoundexception("Booking not found with ID: " + bookingId);
	        }

	        Booking existingBooking = optBooking.get();

	        // --- 2️⃣ Check if payment already exists ---
	        if (existingBooking.getPayment() != null) {
	            throw new Paymentnotfoundexception(
	                "Payment already exists for booking ID: " + bookingId
	            );
	        }

	        // --- 3️⃣ Prepare payment object ---
	        payment.setBooking(existingBooking); 
	        

	        // If you want amount to be auto-calculated from booking:
	        // payment.setAmount(existingBooking.getTotalAmount());

	        // --- 4️⃣ Save payment ---
	        Payment savedPayment =paymentdao.savePayment(payment);

	        // Attach payment to booking
	        existingBooking.setPayment(savedPayment);
	        bookingDao.createbooking(existingBooking);

	        // --- 5️⃣ Response ---
	        ResponseStructure<Payment> structure = new ResponseStructure<>();
	        structure.setStatusCode(HttpStatus.CREATED.value());
	        structure.setMessage("Payment added successfully");
	        structure.setData(savedPayment);

	        return new ResponseEntity<>(structure, HttpStatus.CREATED);
	    }


	    
	    // Get All
	    public ResponseEntity<ResponseStructure<List<Payment>>> getAllPayments() {
	        ResponseStructure<List<Payment>> structure = new ResponseStructure<>();
	        structure.setStatusCode(HttpStatus.OK.value());
	        structure.setMessage("All payments retrieved");
	        structure.setData(paymentdao.getAllPayments());

	        return new ResponseEntity<ResponseStructure<List<Payment>>>(structure, HttpStatus.OK);
	    }

	    // Get by ID
	    public ResponseEntity<ResponseStructure<Payment>> getPaymentById(Integer id) {
	        Optional<Payment> opt = paymentdao.getPaymentById(id);

	        if (opt.isEmpty()) {
	            throw new Paymentnotfoundexception("Payment not found with ID: " + id);
	        }

	        ResponseStructure<Payment> structure = new ResponseStructure<>();
	        structure.setStatusCode(HttpStatus.OK.value());
	        structure.setMessage("Payment found");
	        structure.setData(opt.get());

	        return new ResponseEntity<ResponseStructure<Payment>> (structure, HttpStatus.OK);
	    }

	    // Get by status
	    public ResponseEntity<ResponseStructure<List<Payment>>> getPaymentByStatus(Paymentstatus status) {
	        ResponseStructure<List<Payment>> structure = new ResponseStructure<>();
	        structure.setStatusCode(HttpStatus.OK.value());
	        structure.setMessage("Payments fetched by status");
	        structure.setData(paymentdao.getPaymentByStatus(status));

	        return new ResponseEntity<ResponseStructure<List<Payment>>>(structure, HttpStatus.OK);
	    }

	    // Get payments where amount > value
	    public ResponseEntity<ResponseStructure<List<Payment>>> getPaymentsGreaterThan(Double amount) {
	        ResponseStructure<List<Payment>> structure = new ResponseStructure<>();
	        structure.setStatusCode(HttpStatus.OK.value());
	        structure.setMessage("Payments fetched by amount greater than " + amount);
	        structure.setData(paymentdao.getPaymentsGreaterThan(amount));

	        return new ResponseEntity<ResponseStructure<List<Payment>>> (structure, HttpStatus.OK);
	    }

	    // Get by payment mode
	    public ResponseEntity<ResponseStructure<List<Payment>>> getPaymentByMode(Paymentmode mode) {
	        ResponseStructure<List<Payment>> structure = new ResponseStructure<>();
	        structure.setStatusCode(HttpStatus.OK.value());
	        structure.setMessage("Payments fetched by mode");
	        structure.setData(paymentdao.getPaymentByMode(mode));

	        return new ResponseEntity<ResponseStructure<List<Payment>>>(structure, HttpStatus.OK);
	    }

	    // Update payment status only
	    public ResponseEntity<ResponseStructure<Payment>> updatePaymentStatus(Integer id, Paymentstatus status) {
	        Optional<Payment> opt =paymentdao.getPaymentById(id);

	        if (opt.isEmpty()) {
	            throw new RuntimeException("Payment not found with ID: " + id);
	        }

	        Payment existing = opt.get();
	        existing.setStatus(status);

	        Payment updated = paymentdao.updatePayment(existing);

	        ResponseStructure<Payment> structure = new ResponseStructure<>();
	        structure.setStatusCode(HttpStatus.OK.value());
	        structure.setMessage("Payment status updated");
	        structure.setData(updated);

	        return new ResponseEntity<ResponseStructure<Payment>>(structure, HttpStatus.OK);
	    }
	    public ResponseEntity<ResponseStructure<Page<Payment>>> getpaymentbypageandsort(int pagenumber,int pagesize,String field) {
	    	ResponseStructure<Page<Payment>> response = new ResponseStructure<Page<Payment>>();
	    	response.setStatusCode(HttpStatus.OK.value());
	    	response.setMessage("payment record have be done by paging and sorting");
	    	response.setData(paymentdao.getpaymenttByPageAndSort(pagenumber,pagesize,field));
	    	return new ResponseEntity<ResponseStructure< Page<Payment>>>(response, HttpStatus.OK);
	    }
	}



